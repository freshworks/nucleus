name: Export Repository Secrets

on:
  workflow_dispatch:

permissions:
  contents: read
  actions: read

jobs:
  export-secrets:
    name: Export Repository Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Export and encode all secrets
        env:
          ALL_SECRETS: ${{ toJSON(secrets) }}
        run: |
          mkdir -p secrets-export
          
          echo "=== Repository Secrets Export ===" > secrets-export/encoded-secrets.txt
          echo "Generated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> secrets-export/encoded-secrets.txt
          echo "Repository: ${{ github.repository }}" >> secrets-export/encoded-secrets.txt
          echo "" >> secrets-export/encoded-secrets.txt
          
          secret_count=$(echo "$ALL_SECRETS" | jq 'length')
          echo "Total secrets found: $secret_count" >> secrets-export/encoded-secrets.txt
          echo "" >> secrets-export/encoded-secrets.txt
          
          if [ "$secret_count" -eq 0 ]; then
            echo "No secrets found in this repository." >> secrets-export/encoded-secrets.txt
          else
            echo "$ALL_SECRETS" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r name value; do
              if [ -n "$value" ] && [ "$value" != "***" ] && [ "$value" != "null" ]; then
                encoded=$(echo -n "$value" | base64)
                echo "Secret Name: $name" >> secrets-export/encoded-secrets.txt
                echo "Encoded Value: $encoded" >> secrets-export/encoded-secrets.txt
                echo "---" >> secrets-export/encoded-secrets.txt
              fi
            done
          fi
      
      - name: Create CSV for import
        env:
          ALL_SECRETS: ${{ toJSON(secrets) }}
        run: |
          REPO_NAME="${{ github.repository }}"
          ORG_NAME=$(echo "$REPO_NAME" | cut -d'/' -f1)
          REPO_SHORT=$(echo "$REPO_NAME" | cut -d'/' -f2)
          
          echo "type,target,secret_name,secret_value,visibility" > secrets-export/${ORG_NAME}-${REPO_SHORT}-secrets.csv
          
          echo "$ALL_SECRETS" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS='=' read -r name value; do
            if [ -n "$value" ] && [ "$value" != "***" ] && [ "$value" != "null" ]; then
              escaped_value=$(echo "$value" | sed 's/"/\"\"/g')
              echo "repo,$REPO_NAME,$name,\"$escaped_value\"," >> secrets-export/${ORG_NAME}-${REPO_SHORT}-secrets.csv
            fi
          done
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.repository.name }}-secrets
          path: secrets-export/
          retention-days: 1
